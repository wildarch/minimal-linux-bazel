genrule(
    name = "config",
    srcs = ["build/autogen.sh"],
    outs = ["config.h"],
    cmd = "cd external/libarchive && ./build/autogen.sh && ./configure \
		    --disable-maintainer-mode \
		    --disable-dependency-tracking \
		    --disable-acl \
		    --without-zlib \
		    --without-bz2lib \
		    --without-iconv \
		    --without-libiconv-prefix \
		    --without-lz4 \
		    --without-lzma \
		    --without-nettle \
		    --without-openssl \
		    --without-xml2 \
		    --without-expat \
		&& cd ../.. && cp external/libarchive/config.h $@",
    local = 1,
)

cc_binary(
    name = "cpio",
    srcs = [
        "cpio/cmdline.c",
        "cpio/cpio.c",
        "cpio/cpio.h",
        "cpio/cpio_platform.h",
        ":config",
    ],
    deps = [
        ":libarchive",
        ":libarchive_fe",
    ],
    visibility = ["//visibility:public"],
)

cc_library(
    name = "libarchive_fe",
    srcs = glob(["libarchive_fe/*.c"]) + [":config"],
    hdrs = glob(["libarchive_fe/*.h"]),
    strip_include_prefix = "libarchive_fe/",
)

cc_library(
    name = "libarchive",
    srcs = [":config"] + glob(
        ["libarchive/*.c"],
    ) + glob(
        ["libarchive/*.h"],
        exclude = [
            "libarchive/archive.h",
            "libarchive/archive_entry.h",
        ],
    ),
    hdrs = [
        "libarchive/archive.h",
        "libarchive/archive_entry.h",
    ],
    copts = [
        "-DHAVE_CONFIG_H",
    ],
    strip_include_prefix = "libarchive",
    visibility = ["//visibility:public"],
)
